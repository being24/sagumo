name: Deploy

on:
  push:
    branches: [ master ]

jobs:
  Deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: create secret_key
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        mkdir -p -m 700 ~/.ssh
        echo "$SECRET_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
    - name: deploy
      env:
        SSH_USER: ${{ secrets.USER_NAME }}
        SSH_ADDR: ${{ secrets.LIGHTSAIL_IP_ADDR }}
      run: |
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        ssh -A -oStrictHostKeyChecking=no ${SSH_USER}@${SSH_ADDR} "cd && bash deploy.sh"
